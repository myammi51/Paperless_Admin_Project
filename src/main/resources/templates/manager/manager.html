<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>미배정 업무 배정(팀장 전용) · 팽구청</title>

  <!-- CSRF -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/manager/css/manager.css}" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
    (function () {
      var token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      var header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
      if (token && header && window.$) {
        $.ajaxSetup({ beforeSend: function (xhr) { xhr.setRequestHeader(header, token); } });
      }
    })();
  </script>
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main">
      <h1 class="page-title">미배정 업무 배정 (팀장 전용)</h1>

      <div class="card info-card">
        <div>
          현재 <b th:text="${'미배정 ' + (unassignedCount != null ? unassignedCount : 0) + '건'}">미배정 0건</b>이 있습니다.
          선택하여 담당자에게 배정하세요.
        </div>
      </div>

      <div class="card section">
        <form class="toolbar" th:action="@{/admin/manager}" method="get">
          <input class="input" type="text" name="q" placeholder="제목/접수번호 검색" th:value="${q}" />
          <button class="btn" type="submit">검색</button>
          <a class="btn" th:href="@{/admin/manager}">초기화</a>

          <span class="spacer"></span>

          <div class="inline">
            <label class="muted small">일괄 배정 대상</label>
            <select id="assigneeAll" class="select">
              <option value="">직원 선택</option>
              <option th:each="a : ${adminOptions}" th:value="${a.adminId}" th:text="${a.adminName}"></option>
            </select>
            <button class="btn primary" id="bulkAssignBtn" type="button" disabled>선택 업무 일괄 배정</button>
          </div>
        </form>
      </div>

      <div class="card table-wrap section">
        <table>
          <colgroup>
            <col style="width:36px" />
            <col style="width:100px" />
            <col />
            <col style="width:260px" />
            <col style="width:44px" />
          </colgroup>
          <thead>
            <tr>
              <th class="col-check"><input type="checkbox" id="ckAll" /></th>
              <th class="col-id">접수번호</th>
              <th>제목</th>
              <th class="col-assign">배정</th>
              <th class="col-toggle" aria-label="내용 보기 토글"></th>
            </tr>
          </thead>

          <tbody>
            <th:block th:each="it : ${items}">
              <tr class="item-row">
                <td class="cell-toggle">
                  <input type="checkbox" class="ck" th:value="${it.smgId}" />
                </td>
                <td class="mono cell-toggle" th:text="${'#' + it.smgId}">#0000</td>
                <td class="cell-toggle" th:text="${it.title}">제목</td>

                <td class="assign-cell">
                  <button class="btn btn-secondary" th:onclick="|location.href='/admin/sinmungo_detail/${it.smgId}'|">
                    상세이동
                  </button>

                  <select class="assign-select">
                    <option value="">직원 선택</option>
                    <option th:each="a : ${adminOptions}" th:value="${a.adminId}" th:text="${a.adminName}"></option>
                  </select>

                  <button class="btn btn-assign" type="button" th:attr="data-assign=${it.smgId}">
                    배정
                  </button>
                </td>

                <td class="col-toggle-td">
                  <button type="button" class="caret" title="내용 보기" aria-label="내용 보기"></button>
                </td>
              </tr>

              <tr class="expand-row" style="display:none;">
                <td colspan="5" class="expand-cell">
                  <div class="expand-box">
                    <div class="expand-header">내용</div>
                    <div class="expand-content" th:text="${it.content}">내용 미리보기</div>
                  </div>
                </td>
              </tr>
            </th:block>

            <tr th:if="${#lists.isEmpty(items)}">
              <td colspan="5" style="text-align:center; color:#999;">미배정 업무가 없습니다.</td>
            </tr>
          </tbody>
        </table>

        <div class="assign-bar">
          <div class="muted small">선택: <span id="selCount">0</span>건</div>
        </div>
      </div>

      <div class="pager">
        <a class="btn sm" th:classappend="${currentPage == 1} ? ' disabled'"
          th:href="@{/admin/manager(page=${currentPage > 1 ? currentPage - 1 : 1}, size=${pageSize}, q=${q})}">
          이전
        </a>
        <span style="font-size:13px; color:#64748b;"
          th:text="${currentPage + ' / ' + (totalPages == 0 ? 1 : totalPages)}">1 / 1</span>
        <a class="btn sm" th:classappend="${currentPage == totalPages or totalPages == 0} ? ' disabled'"
          th:href="@{/admin/manager(page=${currentPage < totalPages ? currentPage + 1 : totalPages}, size=${pageSize}, q=${q})}">
          다음
        </a>
      </div>

      <div class="actions section">
        <a class="btn" th:href="@{/admin/dashboard}">대시보드로</a>
      </div>
    </main>
  </div>

  <script>
    (function () {
      var links = document.querySelectorAll('.nav a');
      links.forEach(a => a.classList.remove('active'));
      var current = document.querySelector('.nav a[href="/admin/manager"]');
      if (current) current.classList.add('active');
    })();

    $(function () {
      function updateCount() {
        const c = $('.ck:checked').length;
        $('#selCount').text(c);
        $('#bulkAssignBtn').prop('disabled', !(c > 0 && $('#assigneeAll').val()));
      }

      $('#ckAll').on('change', function () { $('.ck').prop('checked', this.checked); updateCount(); });
      $(document).on('change', '.ck', updateCount);
      $('#assigneeAll').on('change', updateCount);

      // 단건 배정
      $(document).on('click', '[data-assign]', function () {
        const smgId = Number($(this).data('assign'));
        const adminId = $(this).closest('tr.item-row').find('.assign-select').val();
        if (!adminId) { alert('담당자를 선택하세요.'); return; }

        $.ajax({
          url: '/admin/manager/assign',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ smgId, adminId }),
          success: function (res) { alert(res.message || '처리되었습니다.'); location.reload(); },
          error: function (xhr) { alert(xhr.responseJSON?.message || '처리 중 오류가 발생했습니다.'); }
        });
      });

      // 일괄 배정
      $('#bulkAssignBtn').on('click', function () {
        const adminId = $('#assigneeAll').val();
        if (!adminId) { alert('담당자를 선택하세요.'); return; }
        const ids = $('.ck:checked').map(function () { return Number(this.value); }).get();
        if (ids.length === 0) { alert('선택된 업무가 없습니다.'); return; }

        $.ajax({
          url: '/admin/manager/assign/bulk',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ ids, adminId }),
          success: function (res) { alert(res.message || '처리되었습니다.'); location.reload(); },
          error: function (xhr) { alert(xhr.responseJSON?.message || '처리 중 오류가 발생했습니다.'); }
        });
      });

      function toggleExpand($itemRow) {
        const $expand = $itemRow.next('.expand-row');
        const $caret = $itemRow.find('.caret');
        const isOpen = $expand.is(':visible');
        if (isOpen) { $expand.hide(); $caret.removeClass('open'); }
        else { $expand.show(); $caret.addClass('open'); }
      }

      $(document).on('click', 'tr.item-row td', function (e) {
        if ($(e.target).closest('input, select, button, a, label').length) return;
        toggleExpand($(this).closest('tr.item-row'));
      });

      $(document).on('click', '.caret', function (e) {
        e.stopPropagation();
        toggleExpand($(this).closest('tr.item-row'));
      });
    });
  </script>
</body>

</html>