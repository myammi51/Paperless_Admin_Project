<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>회원관리(팀장 전용) · 팽구청</title>

  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/members/css/members.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main">
      <h1 class="page-title">회원관리 (팀장 전용)</h1>

      <!-- <section class="cards" aria-label="요약 지표">
        <div class="card kpi">
          <div class="label">전체 회원</div>
          <div class="value" th:text="${kpiTotal != null ? #numbers.formatInteger(kpiTotal, 0, 'COMMA') : '-'}">0</div>
        </div>
        <div class="card kpi">
          <div class="label">활성(ACTIVE)</div>
          <div class="value" th:text="${kpiActive != null ? #numbers.formatInteger(kpiActive, 0, 'COMMA') : '-'}">0
          </div>
        </div>
        <div class="card kpi">
          <div class="label">비활성(DISABLED)</div>
          <div class="value" th:text="${kpiDisabled != null ? #numbers.formatInteger(kpiDisabled, 0, 'COMMA') : '-'}">0
          </div>
        </div>
      </section> -->

      <div class="card info-card" style="margin-top:14px;">
        <div>
          일반 사용자 계정을 <b>검색</b>하고, <b>조회</b> 및 <b>삭제</b>할 수 있습니다.
        </div>
      </div>

      <div class="card section">
        <form class="toolbar" th:action="@{/admin/members}" method="get">
          <input class="input" type="text" name="q" placeholder="ID/이름/이메일 검색" th:value="${q}" />

          <!-- <select class="select" name="status" th:value="${status}">
            <option value="">상태(전체)</option>
            <option value="ACTIVE" th:selected="${status=='ACTIVE'}">ACTIVE</option>
            <option value="DISABLED" th:selected="${status=='DISABLED'}">DISABLED</option>
            <option value="PENDING" th:selected="${status=='PENDING'}">PENDING</option>
          </select> -->

          <select class="select" name="sort" th:value="${sort}">
            <option value="createdAt" th:selected="${sort == 'createdAt'}">가입일</option>
            <option value="loginId" th:selected="${sort == 'loginId'}">로그인ID</option>
            <option value="userName" th:selected="${sort == 'userName'}">이름</option>
          </select>
          <select class="select" name="dir" th:value="${dir}">
            <option value="desc" th:selected="${dir == 'desc'}">내림차순</option>
            <option value="asc" th:selected="${dir == 'asc'}">오름차순</option>
          </select>

          <button class="btn" type="submit">검색</button>
          <a class="btn" th:href="@{/admin/members}">초기화</a>

          <!-- 
          <span class="spacer"></span>
          <button class="btn primary" type="button" id="openCreate">신규 회원 생성</button>
          -->
        </form>
      </div>

      <div class="card table-wrap section">
        <div class="table-caption" th:text="${'총 ' + (totalCount!=null? totalCount : 0) + '건'}">총 0건</div>
        <table>
          <thead>
            <tr>
              <th class="col-id">번호</th>
              <th>로그인ID</th>
              <th>이름</th>
              <!-- <th>상태</th> -->
              <th>이메일</th>
              <th>가입일</th>
              <th class="col-actions">작업</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="m,iter : ${items}">
              <td class="mono" th:text="${totalCount - ((currentPage - 1) * pageSize) - iter.index}">1</td>
              <td class="mono" th:text="${m.loginId}">user01</td>
              <td th:text="${m.userName}">홍길동</td>

              <!-- 
              <td>
                <select class="select js-status" th:data-id="${m.userId}">
                  <option value="ACTIVE" th:selected="${m.status=='ACTIVE'}">ACTIVE</option>
                  <option value="DISABLED" th:selected="${m.status=='DISABLED'}">DISABLED</option>
                </select>
              </td>
              -->

              <td th:text="${m.email}">-</td>
              <td th:text="${m.createdAt != null ? #temporals.format(m.createdAt, 'yyyy-MM-dd') : '-'}">-</td>
              <td>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                  <!--
                  <button class="btn sm js-save" type="button" th:data-id="${m.userId}">저장</button>
                  <button class="btn sm" type="button" th:data-id="${m.userId}" th:if="${m.status!='DISABLED'}"
                    onclick="quickSetStatus(this, 'DISABLED')">잠금</button>
                  <button class="btn sm" type="button" th:data-id="${m.userId}" th:if="${m.status!='ACTIVE'}"
                    onclick="quickSetStatus(this, 'ACTIVE')">해제</button>
                  <button class="btn sm" type="button" th:data-id="${m.userId}" onclick="resetPw(this)">비번초기화</button>
                  -->
                  <button class="btn sm danger" type="button" th:data-id="${m.userId}"
                    onclick="deleteMember(this)">삭제</button>
                </div>
              </td>
            </tr>
            <tr th:if="${#lists.isEmpty(items)}">
              <td colspan="7" style="text-align:center; color:#999;">검색 결과가 없습니다.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <a class="btn sm" th:classappend="${currentPage == 1} ? ' disabled'"
          th:href="@{/admin/members(page=${currentPage > 1 ? currentPage - 1 : 1}, size=${pageSize}, q=${q}, status=${status}, sort=${sort}, dir=${dir})}">
          이전
        </a>

        <span style="font-size:13px; color:#64748b;"
          th:text="${currentPage + ' / ' + (totalPages == 0 ? 1 : totalPages)}">1 / 1</span>

        <a class="btn sm" th:classappend="${currentPage == totalPages or totalPages == 0} ? ' disabled'"
          th:href="@{/admin/members(page=${currentPage < totalPages ? currentPage + 1 : totalPages}, size=${pageSize}, q=${q}, status=${status}, sort=${sort}, dir=${dir})}">
          다음
        </a>
      </div>

      <div class="actions section">
        <a class="btn" th:href="@{/admin/dashboard}">대시보드로</a>
      </div>
    </main>
  </div>

  <!-- 
  <div class="pl-modal-overlay" id="createModal" aria-hidden="true" style="display:none;">
    ...
  </div>
  -->

  <script>
    (function () {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const current = document.querySelector('.nav a[href="/admin/members"]');
      if (current) current.classList.add('active');
    })();

    (function () {
      const token = document.querySelector('meta[name="_csrf"]')?.content;
      const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
      if (token) $(document).ajaxSend((_, xhr) => xhr.setRequestHeader(header, token));
    })();

    /* 
    $(document).on('click', '.js-save', function () { ... });
    function quickSetStatus(btn, status) { ... }
    function resetPw(btn) { ... }
    const modal = document.getElementById('createModal');
    $('#openCreate').on('click', openModal);
    $('#createMemberForm').on('submit', ... );
    */

    function deleteMember(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('정말 이 계정을 삭제하시겠습니까?')) return;
      $.post(`/admin/members/${id}/delete`)
        .done(res => { alert(res.message || '삭제되었습니다.'); location.reload(); })
        .fail(xhr => alert(xhr.responseJSON?.message || '삭제 중 오류가 발생했습니다.'));
    }
  </script>
</body>

</html>