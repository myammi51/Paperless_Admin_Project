<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>회원관리(팀장 전용) · 팽구청</title>

  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/members/css/members.css}">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main">
      <h1 class="page-title">회원관리 (팀장 전용)</h1>

      <section class="cards" aria-label="요약 지표">
        <div class="card kpi">
          <div class="label">전체 회원</div>
          <div class="value" th:text="${kpiTotal != null ? #numbers.formatInteger(kpiTotal, 0, 'COMMA') : '-'}">0</div>
        </div>
        <div class="card kpi">
          <div class="label">활성(ACTIVE)</div>
          <div class="value" th:text="${kpiActive != null ? #numbers.formatInteger(kpiActive, 0, 'COMMA') : '-'}">0
          </div>
        </div>
        <div class="card kpi">
          <div class="label">비활성(DISABLED)</div>
          <div class="value" th:text="${kpiDisabled != null ? #numbers.formatInteger(kpiDisabled, 0, 'COMMA') : '-'}">0
          </div>
        </div>
      </section>

      <div class="card info-card" style="margin-top:14px;">
        <div>
          일반 사용자 계정을 <b>검색</b>하고, <b>생성</b>, <b>상태 변경</b>, <b>비밀번호 초기화</b>, <b>삭제</b>할 수 있습니다.
        </div>
      </div>

      <div class="card section">
        <form class="toolbar" th:action="@{/admin/members}" method="get">
          <input class="input" type="text" name="q" placeholder="ID/이름/이메일 검색" th:value="${q}" />

          <select class="select" name="status" th:value="${status}">
            <option value="">상태(전체)</option>
            <option value="ACTIVE" th:selected="${status=='ACTIVE'}">ACTIVE</option>
            <option value="DISABLED" th:selected="${status=='DISABLED'}">DISABLED</option>
            <option value="PENDING" th:selected="${status=='PENDING'}">PENDING</option>
          </select>

          <select class="select" name="sort" th:value="${sort}">
            <option value="createdAt" th:selected="${sort == 'createdAt'}">가입일</option>
            <option value="loginId" th:selected="${sort == 'loginId'}">로그인ID</option>
            <option value="userName" th:selected="${sort == 'userName'}">이름</option>
          </select>
          <select class="select" name="dir" th:value="${dir}">
            <option value="desc" th:selected="${dir == 'desc'}">내림차순</option>
            <option value="asc" th:selected="${dir == 'asc'}">오름차순</option>
          </select>

          <button class="btn" type="submit">검색</button>
          <a class="btn" th:href="@{/admin/members}">초기화</a>

          <span class="spacer"></span>
          <button class="btn primary" type="button" id="openCreate">신규 회원 생성</button>
        </form>
      </div>

      <div class="card table-wrap section">
        <div class="table-caption" th:text="${'총 ' + (totalCount!=null? totalCount : 0) + '건'}">총 0건</div>
        <table>
          <thead>
            <tr>
              <th class="col-id">번호</th>
              <th>로그인ID</th>
              <th>이름</th>
              <th>상태</th>
              <th>이메일</th>
              <th>가입일</th>
              <th class="col-actions">작업</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="m,iter : ${items}">
              <td class="mono" th:text="${totalCount - ((currentPage - 1) * pageSize) - iter.index}">1</td>
              <td class="mono" th:text="${m.loginId}">user01</td>
              <td th:text="${m.userName}">홍길동</td>
              <td>
                <select class="select js-status" th:data-id="${m.userId}">
                  <option value="ACTIVE" th:selected="${m.status=='ACTIVE'}">ACTIVE</option>
                  <option value="DISABLED" th:selected="${m.status=='DISABLED'}">DISABLED</option>
                  <!-- <option value="PENDING" th:selected="${m.status=='PENDING'}">PENDING</option> -->
                </select>
              </td>
              <td th:text="${m.email}">-</td>
              <td th:text="${m.createdAt != null ? #temporals.format(m.createdAt, 'yyyy-MM-dd') : '-'}">-</td>
              <td>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                  <button class="btn sm js-save" type="button" th:data-id="${m.userId}">저장</button>
                  <button class="btn sm" type="button" th:data-id="${m.userId}" th:if="${m.status!='DISABLED'}"
                    onclick="quickSetStatus(this, 'DISABLED')">잠금</button>
                  <button class="btn sm" type="button" th:data-id="${m.userId}" th:if="${m.status!='ACTIVE'}"
                    onclick="quickSetStatus(this, 'ACTIVE')">해제</button>

                  <button class="btn sm" type="button" th:data-id="${m.userId}" onclick="resetPw(this)">비번초기화</button>
                  <button class="btn sm danger" type="button" th:data-id="${m.userId}"
                    onclick="deleteMember(this)">삭제</button>
                </div>
              </td>
            </tr>
            <tr th:if="${#lists.isEmpty(items)}">
              <td colspan="7" style="text-align:center; color:#999;">검색 결과가 없습니다.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <a class="btn sm" th:classappend="${currentPage == 1} ? ' disabled'"
          th:href="@{/admin/members(page=${currentPage > 1 ? currentPage - 1 : 1}, size=${pageSize}, q=${q}, status=${status}, sort=${sort}, dir=${dir})}">
          이전
        </a>

        <span style="font-size:13px; color:#64748b;"
          th:text="${currentPage + ' / ' + (totalPages == 0 ? 1 : totalPages)}">1 / 1</span>

        <a class="btn sm" th:classappend="${currentPage == totalPages or totalPages == 0} ? ' disabled'"
          th:href="@{/admin/members(page=${currentPage < totalPages ? currentPage + 1 : totalPages}, size=${pageSize}, q=${q}, status=${status}, sort=${sort}, dir=${dir})}">
          다음
        </a>
      </div>

      <div class="actions section">
        <a class="btn" th:href="@{/admin/dashboard}">대시보드로</a>
      </div>
    </main>
  </div>

  <div class="pl-modal-overlay" id="createModal" aria-hidden="true" style="display:none;">
    <div class="pl-modal" role="dialog" aria-modal="true" aria-labelledby="createModalTitle">
      <div class="pl-modal__header">
        <h3 id="createModalTitle">신규 회원 생성</h3>
        <button type="button" class="pl-icon-btn" data-close-modal>×</button>
      </div>

      <form id="createMemberForm" class="pl-modal__body">
        <div class="pl-field">
          <label for="c_loginId">로그인ID (필수)</label>
          <input id="c_loginId" name="loginId" class="pl-input" required>
        </div>

        <div class="pl-grid-2">
          <div class="pl-field">
            <label for="c_userName">이름</label>
            <input id="c_userName" name="userName" class="pl-input">
          </div>
          <div class="pl-field">
            <label for="c_phone">휴대폰</label>
            <input id="c_phone" name="phoneNum" class="pl-input">
          </div>
        </div>

        <div class="pl-field">
          <label for="c_email">이메일</label>
          <input id="c_email" name="email" type="email" class="pl-input">
        </div>

        <div class="pl-grid-2">
          <div class="pl-field">
            <label for="c_status">상태</label>
            <select id="c_status" name="status" class="pl-select">
              <option value="ACTIVE">ACTIVE</option>
              <option value="DISABLED">DISABLED</option>
              <option value="PENDING">PENDING</option>
            </select>
          </div>
          <div class="pl-field">
            <label for="c_tempPw">임시 비밀번호</label>
            <input id="c_tempPw" name="tempPassword" class="pl-input" placeholder="미입력 시 자동발급">
          </div>
        </div>

        <div class="pl-modal__footer">
          <button type="button" class="pl-btn" data-close-modal>취소</button>
          <button type="submit" class="pl-btn pl-btn--primary">생성</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const current = document.querySelector('.nav a[href="/admin/members"]');
      if (current) current.classList.add('active');
    })();

    (function () {
      const token = document.querySelector('meta[name="_csrf"]')?.content;
      const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
      if (token) $(document).ajaxSend((_, xhr) => xhr.setRequestHeader(header, token));
    })();

    $(document).on('click', '.js-save', function () {
      const id = $(this).data('id');
      const status = $(`.js-status[data-id="${id}"]`).val();
      $.ajax({
        url: `/admin/members/${id}/update`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ status }),
        success: (res) => { alert(res.message || '저장되었습니다.'); location.reload(); },
        error: (xhr) => { alert(xhr.responseJSON?.message || '오류가 발생했습니다.'); }
      });
    });

    function quickSetStatus(btn, status) {
      const id = btn.getAttribute('data-id');
      $.ajax({
        url: `/admin/members/${id}/update`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ status }),
        success: (res) => { alert(res.message || '처리되었습니다.'); location.reload(); },
        error: (xhr) => { alert(xhr.responseJSON?.message || '오류가 발생했습니다.'); }
      });
    }

    function resetPw(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('임시 비밀번호를 발급하시겠습니까?')) return;
      $.post(`/admin/members/${id}/reset-password`)
        .done(res => {
          alert((res.message || '완료') + (res.tempPassword ? `\n임시비번: ${res.tempPassword}` : ''));
          location.reload();
        })
        .fail(xhr => alert(xhr.responseJSON?.message || '오류가 발생했습니다.'));
    }

    function deleteMember(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('정말 이 계정을 삭제하시겠습니까?')) return;
      $.post(`/admin/members/${id}/delete`)
        .done(res => { alert(res.message || '삭제되었습니다.'); location.reload(); })
        .fail(xhr => alert(xhr.responseJSON?.message || '삭제 중 오류가 발생했습니다.'));
    }

    const modal = document.getElementById('createModal');
    const form = document.getElementById('createMemberForm');
    function openModal() { modal.style.display = 'grid'; modal.setAttribute('aria-hidden', 'false'); setTimeout(() => document.getElementById('c_loginId')?.focus(), 0); }
    function closeModal() { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); form?.reset(); }
    $('#openCreate').on('click', openModal);
    $(document).on('click', '[data-close-modal]', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    $('#createMemberForm').on('submit', function (e) {
      e.preventDefault();
      const payload = {
        loginId: $('#c_loginId').val().trim(),
        userName: $('#c_userName').val().trim(),
        email: $('#c_email').val().trim(),
        phoneNum: $('#c_phone').val().trim(),
        status: $('#c_status').val(),
        tempPassword: $('#c_tempPw').val().trim()
      };
      if (!payload.loginId) { alert('로그인ID를 입력하세요.'); return; }
      $.ajax({
        url: '/admin/members',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: (res) => {
          let msg = res.message || '생성되었습니다.';
          if (res.tempPassword) msg += `\n임시비번: ${res.tempPassword}`;
          alert(msg);
          location.reload();
        },
        error: (xhr) => alert(xhr.responseJSON?.message || '오류가 발생했습니다.')
      });
    });
  </script>
</body>

</html>