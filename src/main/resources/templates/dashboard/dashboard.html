<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>팽구청 · 대시보드</title>
  <link rel="stylesheet" th:href="@{/admin/css/admin.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" style="padding-bottom: 30px;" role="main">
      <section class="cards" aria-label="요약 지표">
        <div class="card kpi">
          <div class="label">전체 민원(누적)</div>
          <div class="value" th:text="${kpiTotal != null ? #numbers.formatInteger(kpiTotal, 0, 'COMMA') : '-'}">0</div>
        </div>
        <div class="card kpi">
          <div class="label">오늘 접수</div>
          <div class="value"
            th:text="${kpiTodayReceived != null ? #numbers.formatInteger(kpiTodayReceived, 0, 'COMMA') : '-'}">0</div>
        </div>
        <div class="card kpi">
          <div class="label">내게 배정</div>
          <div class="value" th:text="${kpiAssigned != null ? #numbers.formatInteger(kpiAssigned, 0, 'COMMA') : '-'}">0
          </div>
        </div>
      </section>

      <section class="section" aria-label="공지사항">
        <h2>공지사항</h2>
        <div class="card">
          <ul class="activity-list" aria-describedby="공지설명">
            <li th:each="n : ${noticesTop}">
              <span class="activity-time mono"
                th:text="${n.createdAt != null ? #temporals.format(n.createdAt, 'MM-dd') : '--'}">--</span>
              <a th:href="@{|/admin/notice_detail/${n.noticeId}|}" th:text="${n.title}">공지 제목</a>
            </li>

            <li th:if="${noticesTop == null or #lists.isEmpty(noticesTop)}" style="color:var(--muted);">표시할 공지사항이 없습니다.
            </li>
          </ul>

          <div style="margin-top:8px;">
            <a class="btn sm" th:href="@{/admin/notice}">공지사항 더보기</a>
          </div>
        </div>
      </section>

      <div style="margin-top: 20px;"></div>

      <div class="chart-wrap" style="margin-bottom:20px;">
        <h2>최근 7일 신문고 접수 추이</h2>
        <div id="received7Empty" style="display:none;color:#64748b;font-size:14px;margin:8px 0;">
          데이터가 없습니다.
        </div>
        <canvas id="received7Chart" role="img" aria-label="최근 7일 접수 추이"></canvas>
      </div>

      <div style="height: 30px;"></div>

      <div class="chart-wrap" style="margin-bottom: 30px;">
        <h2>신문고 전체 상태별 분포</h2>
        <div id="statusPieEmpty" style="display:none;color:#64748b;font-size:14px;margin:8px 0;">
          데이터가 없습니다.
        </div>
        <canvas id="statusPieChart" role="img" aria-label="상태별 분포"></canvas>
      </div>
    </main>
  </div>

  <script th:inline="javascript">
    const recent7 = /*[[${recent7}]]*/[];
    const statusLabels = /*[[${statusLabels}]]*/[];
    const statusCounts = /*[[${statusCounts}]]*/[];
  </script>

  <script>
    (function () {
      if (!window.Chart) return;
      const el = document.getElementById('statusPieChart');
      const empty = document.getElementById('statusPieEmpty');

      const total = (statusCounts || []).reduce((a, b) => a + (+b || 0), 0);
      if (total === 0) {
        if (empty) empty.style.display = 'block';
        if (el) el.style.display = 'none';
        return;
      }

      new Chart(el, {
        type: 'pie',
        data: {
          labels: statusLabels || ['접수', '승인', '보류', '반려'],
          datasets: [{
            data: statusCounts || [0, 0, 0, 0],
            backgroundColor: [
              '#60A5FA', // 접수 - 파스텔 블루
              '#34D399', // 승인 - 파스텔 그린
              '#FBBF24', // 보류 - 파스텔 옐로우
              '#F87171'  // 반려 - 파스텔 레드
            ]
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { color: '#374151', font: { size: 13 } } } }
        }
      });
    })();
  </script>
  <script>
    (function initBarChart() {
      if (!window.Chart) return;
      const el = document.getElementById('received7Chart');
      const empty = document.getElementById('received7Empty');
      if (!el) return;

      const labels = (recent7 || []).map(d => d.label);
      const counts = (recent7 || []).map(d => Number(d.count || 0));
      const total = counts.reduce((a, b) => a + (b || 0), 0);

      if (!labels.length || total === 0) {
        if (empty) empty.style.display = 'block';
        el.style.display = 'none';
        return;
      }

      new Chart(el, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '접수',
            data: counts,
            borderRadius: 6,
            backgroundColor: 'rgba(96,165,250,0.65)'  // 파스텔 블루
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#374151', font: { size: 13 } } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { color: '#475569' }, grid: { color: '#e5e7eb' } },
            y: { ticks: { color: '#475569' }, grid: { color: '#e5e7eb' }, beginAtZero: true, precision: 0 }
          }
        }
      });
    })();
  </script>

</body>

</html>