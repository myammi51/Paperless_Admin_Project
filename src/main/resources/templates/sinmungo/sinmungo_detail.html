<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${'민원 상세 · #' + dto.smgId}">민원 상세</title>
  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/sinmungo/css/sinmungo.css}" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main" th:classappend="${dto.status != '접수'} ? ' is-locked' : ''">
      <h1 class="page-title">
        <span th:text="${'민원 #' + dto.smgId}">민원 #0000</span>
        <span> · </span>
        <span th:text="${dto.title}">제목</span>
      </h1>

      <div class="notice success" th:if="${msg != null}" th:text="${msg}" style="margin-bottom:12px;"></div>

      <div class="card section">
        <dl class="meta-card" style="display:grid;grid-template-columns:110px 1fr;row-gap:6px;column-gap:8px;margin:0;">
          <dt style="color:#64748b;">신청인</dt>
          <dd>
            <span
              th:text="${dto.writerName != null ? dto.writerName : (dto.writerId != null ? 'ID ' + dto.writerId : '-')}">-</span>
            <span th:if="${telNumHyphen != null}" th:text="${' (' + telNumHyphen + ')'}"></span>
          </dd>

          <dt style="color:#64748b;">접수일</dt>
          <dd>
            <span th:if="${dto.createdAt != null}"
              th:text="${#temporals.format(dto.createdAt, 'yyyy-MM-dd HH:mm')}">-</span>
            <span th:if="${dto.createdAt == null}">-</span>
          </dd>

          <dt style="color:#64748b;">상태</dt>
          <dd th:switch="${dto.status}">
            <span th:case="'접수'" class="badge badge--pending">접수</span>
            <span th:case="'승인'" class="badge badge--success">승인</span>
            <span th:case="'반려'" class="badge badge--warn">반려</span>
            <span th:case="'보류'" class="badge badge--hold">보류</span>
            <span th:case="*" class="badge badge--default">-</span>
          </dd>

          <dt style="color:#64748b;">담당자</dt>
          <dd>
            <span
              th:text="${dto.adminName != null ? dto.adminName : (dto.adminId != null ? 'ID ' + dto.adminId : '-')}">-</span>
          </dd>

          <dt style="color:#64748b;">이메일</dt>
          <dd th:text="${#strings.defaultString(dto?.noticeEmail, '-')}">-</dd>

          <dt style="color:#64748b;">문자 수신</dt>
          <dd th:text="${dto.noticeSms == 'Y' ? '동의(Y)' : (dto?.noticeSms == 'N' ? '미동의(N)' : '-')}">-</dd>

          <dt style="color:#64748b;">주소</dt>
          <dd>
            <span th:text="${dto.postcode != null ? '[' + dto.postcode + '] ' : ''}"></span>
            <span th:text="${dto.addr1 != null ? dto.addr1 : ''}"></span>
            <span th:text="${dto.addr2 != null ? ' ' + dto.addr2 : ''}"></span>
            <span th:if="${dto.postcode == null && dto.addr1 == null && dto.addr2 == null}">-</span>
          </dd>
        </dl>
      </div>

      <div class="card section">
        <h2 class="page-title" style="font-size:16px;">본문</h2>
        <div class="prose" th:utext="${#strings.escapeXml(dto.content)?.replaceAll('\n','<br/>')}"></div>
      </div>

      <div class="card section" th:if="${dto.status == '반려' and !#strings.isEmpty(dto.rejectReason)}">
        <h2 class="page-title" style="font-size:16px;">반려 사유</h2>
        <div class="prose" style="white-space:pre-wrap; color:#991b1b;">
          <span th:text="${dto.rejectReason}">사유</span>
        </div>
      </div>

      <div class="card section" th:if="${files != null}">
        <h2 class="page-title" style="font-size:16px;">첨부파일</h2>

        <div th:if="${#lists.isEmpty(files)}" style="color:#64748b;">첨부된 파일이 없습니다.</div>

        <div class="attach-grid" th:if="${!#lists.isEmpty(files)}">
          <div class="attach-item" th:each="f, iterStat : ${files}">
            <div class="thumb" th:if="${f.mimeType != null and #strings.startsWith(f.mimeType, 'image/')}" role="button"
              tabindex="0" th:attr="data-fileid=${f.fileId},data-filename=${f.fileName},data-index=${iterStat.index}"
              aria-label="이미지 크게 보기">
              <img th:src="@{|/files/${f.fileId}/view|}" th:alt="${f.fileName}" loading="lazy" />
              <a class="thumb__dl" th:href="@{|/files/${f.fileId}/download|}"
                th:attr="aria-label=${'다운로드: ' + f.fileName}" title="다운로드" onclick="event.stopPropagation();">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="16" height="16">
                  <path
                    d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4.001 4a1 1 0 0 1-1.414 0l-4.001-4a1 1 0 1 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1zM5 19a1 1 0 1 0 0 2h14a1 1 0 1 0 0-2H5z"
                    fill="currentColor" />
                </svg>
              </a>
            </div>

            <div th:if="${!(f.mimeType != null and #strings.startsWith(f.mimeType, 'image/'))}">
              <a th:href="@{|/files/${f.fileId}/download|}" class="file-download">
                <span th:text="${f.fileName}"></span>
              </a>
            </div>

            <div class="filename one-line" th:title="${f.fileName}" th:text="${f.fileName}"></div>
          </div>
        </div>
      </div>

      <div class="card section">
        <h2 class="page-title" style="font-size:16px;">시민 답변(발송용)</h2>

        <div th:if="${!(dto.status == '접수' or dto.status == '보류')}" style="margin:0 0 8px; font-size:13px; color:#64748b;">
          현재 상태(<span th:text="${dto.status}">-</span>)에서는 답변을 수정할 수 없습니다.
        </div>

        <textarea class="textarea" id="adminAnswer" name="adminAnswer" rows="10" placeholder="시민에게 발송할 답변을 작성하세요."
          th:text="${dto.adminAnswer}"
          th:attr="readonly=${!(dto.status == '접수' or dto.status == '보류')}, disabled=${!(dto.status == '접수' or dto.status == '보류')}"></textarea>

        <div th:if="${dto.answerDate != null}" style="margin-top:8px; color:#64748b; font-size:13px;">
          마지막 등록일:
          <span th:text="${#temporals.format(dto.answerDate, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
      </div>

      <div class="actions section actions-bar">
        <div class="left">
          <a class="btn" th:href="@{/admin/sinmungo_list}">목록으로</a>
        </div>

        <div class="center" style="display:flex;gap:8px;flex-wrap:wrap;" th:if="${dto.status == '접수' or dto.status == '보류'}">
          <form id="statusForm" th:action="@{|/admin/sinmungo_detail/${dto.smgId}/status|}" method="post">
            <input type="hidden" name="action" id="statusAction" />
            <input type="hidden" name="rejectReason" id="rejectReasonHidden" />
            <input type="hidden" name="adminAnswer" id="answerHidden" />
          </form>

          <button class="btn primary" type="button" onclick="submitStatus('approve')">승인</button>
          <button class="btn" type="button" onclick="submitStatus('hold')">보류</button>
          <button class="btn warn" type="button" onclick="openRejectModal()">반려</button>
        </div>
      </div>
    </main>
  </div>

  <div id="rejectModal" class="modal-backdrop" aria-hidden="true" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rejectTitle">
      <header id="rejectTitle">반려 사유 입력</header>
      <div class="body">
        <p style="margin:0 0 8px;color:#64748b;">반려 사유를 구체적으로 입력해 주세요.</p>
        <textarea id="rejectReasonInput" class="textarea" placeholder="예) 관할 부서 아님, 추가 서류 필요 등" required></textarea>
      </div>
      <div class="footer">
        <button class="btn" type="button" onclick="closeRejectModal()">취소</button>
        <button class="btn warn" type="button" onclick="submitReject()">반려 확정</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal-backdrop" aria-hidden="true" style="display:none;">
    <div class="modal modal--confirm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <header id="confirmTitle">확인</header>
      <div class="body confirm-body">
        <p id="confirmMessage" class="confirm-text">처리하시겠습니까?</p>
      </div>
      <div class="footer">
        <button id="confirmCancel" class="btn btn-ghost" type="button">취소</button>
        <button id="confirmOk" class="btn primary" type="button">확인</button>
      </div>
    </div>
  </div>

  <div id="imageLightbox" class="lightbox" aria-hidden="true" style="display:none;">
    <div class="lightbox__backdrop" data-close="true"></div>
    <div class="lightbox__content" role="dialog" aria-modal="true" aria-label="이미지 미리보기">
      <button type="button" class="lightbox__close" aria-label="닫기" data-close="true">×</button>
      <img id="lightboxImg" alt="첨부 이미지" />
      <div id="lightboxCaption" class="lightbox__caption"></div>
      <div class="lightbox__nav">
        <button type="button" id="lightboxPrev" class="btn sm" aria-label="이전">‹</button>
        <button type="button" id="lightboxNext" class="btn sm" aria-label="다음">›</button>
        <a id="lightboxDownload" class="btn sm" href="#" download>다운로드</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const active = document.querySelector('.nav a[href="/admin/sinmungo_list"]');
      if (active) active.classList.add('active');

      const grid = document.querySelector('.attach-grid');
      const lb = document.getElementById('imageLightbox');
      const lbImg = document.getElementById('lightboxImg');
      const lbCaption = document.getElementById('lightboxCaption');
      const lbDownload = document.getElementById('lightboxDownload');
      const btnPrev = document.getElementById('lightboxPrev');
      const btnNext = document.getElementById('lightboxNext');

      let items = [];
      let lbIndex = 0;

      if (grid) {
        const thumbs = grid.querySelectorAll('.thumb[data-fileid]');
        items = Array.from(thumbs).map((el) => ({
          id: el.getAttribute('data-fileid'),
          filename: el.getAttribute('data-filename')
        }));

        thumbs.forEach((el, idx) => {
          el.addEventListener('click', () => openAt(idx));
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openAt(idx);
            }
          });
        });

        btnPrev.addEventListener('click', () => move(-1));
        btnNext.addEventListener('click', () => move(1));
        lb.addEventListener('click', (e) => {
          if (e.target.dataset.close === 'true') closeLb();
        });
        document.addEventListener('keydown', (e) => {
          if (lb.style.display !== 'none') {
            if (e.key === 'Escape') closeLb();
            if (e.key === 'ArrowLeft') move(-1);
            if (e.key === 'ArrowRight') move(1);
          }
        });
      }

      function openAt(index) {
        if (!items.length) return;
        lbIndex = index;
        render();
        lb.style.display = 'block';
        lb.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      function closeLb() {
        lb.style.display = 'none';
        lb.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      function move(delta) {
        lbIndex = (lbIndex + delta + items.length) % items.length;
        render();
      }

      function render() {
        const item = items[lbIndex];
        const viewUrl = `/files/${item.id}/view`;
        const dlUrl = `/files/${item.id}/download`;
        lbImg.src = viewUrl;
        lbImg.alt = item.filename || '첨부 이미지';
        lbCaption.textContent = item.filename || '';
        lbDownload.href = dlUrl;
        lbDownload.setAttribute('download', item.filename || '');
      }

      function ensureAnswerHidden() {
        const answer = document.getElementById('adminAnswer')?.value || '';
        const hidden = document.getElementById('answerHidden');
        if (hidden) hidden.value = answer;
      }

      window.openRejectModal = function () {
        const m = document.getElementById('rejectModal');
        m.style.display = 'flex';
        m.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        setTimeout(() => document.getElementById('rejectReasonInput').focus(), 0);
      }
      window.closeRejectModal = function () {
        const m = document.getElementById('rejectModal');
        m.style.display = 'none';
        m.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        document.getElementById('rejectReasonInput').value = '';
      }
      window.submitReject = function () {
        const reason = document.getElementById('rejectReasonInput').value.trim();
        if (!reason) { alert('반려 사유를 입력해 주세요.'); return; }
        document.getElementById('statusAction').value = 'reject';
        document.getElementById('rejectReasonHidden').value = reason;
        ensureAnswerHidden();
        document.getElementById('statusForm').submit();
      }

      const confirmModal = document.getElementById('confirmModal');
      const confirmMsgEl = document.getElementById('confirmMessage');
      const confirmOkBtn = document.getElementById('confirmOk');
      const confirmCancelBtn = document.getElementById('confirmCancel');
      let confirmOkHandler = null;

      function openConfirm(message, onOk) {
        confirmMsgEl.textContent = message || '처리하시겠습니까?';
        confirmOkHandler = onOk;

        confirmModal.style.display = 'flex';
        confirmModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        setTimeout(() => confirmOkBtn.focus(), 0);
      }

      function closeConfirm() {
        confirmModal.style.display = 'none';
        confirmModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        confirmOkHandler = null;
      }

      confirmOkBtn.addEventListener('click', () => {
        if (typeof confirmOkHandler === 'function') confirmOkHandler();
        closeConfirm();
      });
      confirmCancelBtn.addEventListener('click', () => {
        closeConfirm();
      });

      document.addEventListener('keydown', (e) => {
        if (confirmModal.style.display !== 'none') {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeConfirm();
          }
          if (e.key === 'Enter') {
            e.preventDefault();
            if (typeof confirmOkHandler === 'function') confirmOkHandler();
            closeConfirm();
          }
        }
      });

      window.submitStatus = function (action) {
        if (action === 'approve') {
          openConfirm('승인 처리하시겠습니까?', () => {
            document.getElementById('statusAction').value = 'approve';
            document.getElementById('rejectReasonHidden').value = '';
            ensureAnswerHidden();
            document.getElementById('statusForm').submit();
          });
          return;
        }
        if (action === 'hold') {
          openConfirm('보류 상태로 변경하시겠습니까?', () => {
            document.getElementById('statusAction').value = 'hold';
            document.getElementById('rejectReasonHidden').value = '';
            ensureAnswerHidden();
            document.getElementById('statusForm').submit();
          });
          return;
        }

        document.getElementById('statusAction').value = action;
        document.getElementById('rejectReasonHidden').value = '';
        ensureAnswerHidden();
        document.getElementById('statusForm').submit();
      }
    })();
  </script>
</body>

</html>