<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${dto != null ? dto.title : '공지사항 상세'}">공지사항 상세</title>
  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/notice/css/notice.css}" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
  <div class="container">
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h1 class="page-title" style="margin:0;">
          <span class="badge badge--pinned" th:if="${dto?.isPinned == 'Y'}">상단</span>
          <span th:text="${dto?.title}">공지 제목</span>
        </h1>

        <div style="display:flex; gap:8px; align-items:center;">
          <a class="btn primary" th:href="@{|/admin/notice_edit/${dto.noticeId}|}">수정</a>

          <form th:action="@{|/admin/notice_delete/${dto.noticeId}|}" method="post"
            onsubmit="return confirm('정말 삭제하시겠습니까? 삭제 후에는 복구할 수 없습니다.');" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn danger">삭제</button>
          </form>
        </div>
      </div>

      <div class="card section">
        <div class="meta-line">
          <span
            th:text="${dto?.createdAt != null ? #temporals.format(dto.createdAt, 'yyyy-MM-dd HH:mm') : '-'}">-</span>
          <span>
            작성자:
            <b
              th:text="${dto?.adminName != null ? dto.adminName : (dto?.adminId != null ? 'ID ' + dto.adminId : '-')}">-</b>
          </span>
          <span>조회: <b th:text="${dto?.viewCount != null ? dto.viewCount : 0}">0</b></span>
        </div>
      </div>

      <div class="card section" style="min-height:160px;">
        <div class="prose" th:utext="${#strings.escapeXml(dto?.content)?.replaceAll('\n','<br/>')}">
          본문
        </div>
      </div>

      <div class="card section" th:if="${files != null}">
        <h2 class="page-title" style="font-size:15px; margin-bottom:8px;">첨부파일</h2>

        <div th:if="${#lists.isEmpty(files)}" style="color:#64748b;">첨부된 파일이 없습니다.</div>

        <div class="attach-grid" th:if="${!#lists.isEmpty(files)}">
          <div class="attach-item" th:each="f, iterStat : ${files}">
            <div class="thumb" th:if="${f.mimeType != null and #strings.startsWith(f.mimeType, 'image/')}" role="button"
              tabindex="0" th:attr="data-fileid=${f.fileId},data-filename=${f.fileName},data-index=${iterStat.index}"
              aria-label="이미지 크게 보기">
              <img th:src="@{|/files/${f.fileId}/view|}" th:alt="${f.fileName}" loading="lazy" />
              <a class="thumb__dl" th:href="@{|/files/${f.fileId}/download|}"
                th:attr="aria-label=${'다운로드: ' + f.fileName}" title="다운로드" onclick="event.stopPropagation();">
                <svg viewBox="0 0 24 24" aria-hidden="true" width="16" height="16">
                  <path
                    d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4.001 4a1 1 0 0 1-1.414 0l-4.001-4a1 1 0 1 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1zM5 19a1 1 0 1 0 0 2h14a1 1 0 1 0 0-2H5z"
                    fill="currentColor" />
                </svg>
              </a>
            </div>

            <div th:if="${!(f.mimeType != null and #strings.startsWith(f.mimeType, 'image/'))}">
              <a th:href="@{|/files/${f.fileId}/download|}" th:text="${f.fileName}">첨부파일명</a>
              <span style="color:#94a3b8;"
                th:text="${' (' + (f.mimeType != null ? f.mimeType : 'application/octet-stream') + ', ' + f.fileSize + ' bytes)'}">
              </span>
            </div>

            <div class="filename one-line" th:title="${f.fileName}" th:text="${f.fileName}"></div>
          </div>
        </div>
      </div>

      <div id="imageLightbox" class="lightbox" aria-hidden="true" style="display:none;">
        <div class="lightbox__backdrop" data-close="true"></div>
        <div class="lightbox__content" role="dialog" aria-modal="true" aria-label="이미지 미리보기">
          <button type="button" class="lightbox__close" aria-label="닫기" data-close="true">×</button>
          <img id="lightboxImg" alt="첨부 이미지" />
          <div id="lightboxCaption" class="lightbox__caption"></div>
          <div class="lightbox__nav">
            <button type="button" id="lightboxPrev" class="btn sm" aria-label="이전">‹</button>
            <button type="button" id="lightboxNext" class="btn sm" aria-label="다음">›</button>
            <a id="lightboxDownload" class="btn sm" href="#" download>다운로드</a>
          </div>
        </div>
      </div>

      <div class="nav-row" th:if="${prev != null or next != null}">
        <a class="btn sm" th:if="${prev != null}" th:href="@{|/admin/notice_detail/${prev.noticeId}|}"
          th:text="${'이전: ' + prev.title}">
          이전
        </a>
        <span th:if="${prev == null}"></span>

        <a class="btn sm" th:if="${next != null}" th:href="@{|/admin/notice_detail/${next.noticeId}|}"
          th:text="${'다음: ' + next.title}">
          다음
        </a>
      </div>

      <div class="actions">
        <a class="btn" th:href="@{/admin/notice}">목록으로</a>
      </div>
    </main>
  </div>

  <script>
    (function () {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const current = document.querySelector('.nav a[href="/admin/notice"]');
      if (current) current.classList.add('active');
    })();

    const grid = document.querySelector('.attach-grid');
    const lb = document.getElementById('imageLightbox');
    const lbImg = document.getElementById('lightboxImg');
    const lbCaption = document.getElementById('lightboxCaption');
    const lbDownload = document.getElementById('lightboxDownload');
    const btnPrev = document.getElementById('lightboxPrev');
    const btnNext = document.getElementById('lightboxNext');

    let items = [];
    let lbIndex = 0;

    if (grid) {
      const thumbs = grid.querySelectorAll('.thumb[data-fileid]');
      items = Array.from(thumbs).map((el) => ({
        id: el.getAttribute('data-fileid'),
        filename: el.getAttribute('data-filename')
      }));

      thumbs.forEach((el, idx) => {
        el.addEventListener('click', () => openAt(idx));
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openAt(idx);
          }
        });
      });

      btnPrev.addEventListener('click', () => move(-1));
      btnNext.addEventListener('click', () => move(1));
      lb.addEventListener('click', (e) => {
        if (e.target.dataset.close === 'true') closeLb();
      });
      document.addEventListener('keydown', (e) => {
        if (lb.style.display !== 'none') {
          if (e.key === 'Escape') closeLb();
          if (e.key === 'ArrowLeft') move(-1);
          if (e.key === 'ArrowRight') move(1);
        }
      });
    }

    function openAt(index) {
      if (!items.length) return;
      lbIndex = index;
      render();
      lb.style.display = 'block';
      lb.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeLb() {
      lb.style.display = 'none';
      lb.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    function move(delta) {
      lbIndex = (lbIndex + delta + items.length) % items.length;
      render();
    }

    function render() {
      const item = items[lbIndex];
      const viewUrl = `/files/${item.id}/view`;
      const dlUrl = `/files/${item.id}/download`;
      lbImg.src = viewUrl;
      lbImg.alt = item.filename || '첨부 이미지';
      lbCaption.textContent = item.filename || '';
      lbDownload.href = dlUrl;
      lbDownload.setAttribute('download', item.filename || '');
    }

  </script>
</body>

</html>