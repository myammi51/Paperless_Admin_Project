<header class="topbar" role="banner" th:fragment="topbar">
  <div class="brand">
    <div class="brand-badge" aria-hidden="true">
      <img th:src="@{/images/logo.png}" alt="팽구청 로고" />
    </div>
    <strong>팽구청</strong>
  </div>

  <div class="topbar-actions">
    <a class="btn sm" th:href="@{|/admin/sinmungo_list/${loginAdmin.adminId}|}">내 업무로 이동</a>
    <button class="btn sm" type="button" id="openPwChange" style="margin-left:8px;">비밀번호 변경</button>
    <span style="margin-left:8px;" th:text="${loginAdmin.adminName}">관리자명</span>

    <form th:action="@{/admin/logout}" method="post" style="display:inline; margin-left:8px;">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <button class="btn sm" type="submit">로그아웃</button>
    </form>
  </div>

  <div class="pl-modal-overlay" id="pwChangeModal" hidden>
    <div class="pl-modal" role="dialog" aria-modal="true" aria-labelledby="pwChangeTitle">
      <div class="pl-modal__header">
        <h3 id="pwChangeTitle">비밀번호 변경</h3>
        <button type="button" class="pl-icon-btn" data-close-modal aria-label="닫기">×</button>
      </div>

      <form id="pwChangeForm" class="pl-modal__body" autocomplete="off">
        <div class="pl-field">
          <label for="curPw">현재 비밀번호</label>
          <input id="curPw" name="curPw" type="password" class="pl-input" required>
        </div>
        <div class="pl-field">
          <label for="newPw">새 비밀번호</label>
          <input id="newPw" name="newPw" type="password" class="pl-input" required>
        </div>
        <div class="pl-field">
          <label for="newPw2">새 비밀번호 확인</label>
          <input id="newPw2" name="newPw2" type="password" class="pl-input" required>
        </div>

        <p class="pl-help" id="pwHelp" style="display:none;"></p>

        <div class="pl-modal__footer">
          <button type="button" class="pl-btn" data-close-modal>취소</button>
          <button type="submit" class="pl-btn pl-btn--primary">변경</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .pl-modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: grid;
      place-items: center;
      background: rgba(15, 23, 42, .45);
      backdrop-filter: blur(2px)
    }

    .pl-modal {
      width: 420px;
      max-width: 90vw;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 24px 60px rgba(2, 6, 23, .22);
      overflow: hidden;
      border: 1px solid #e5e7eb;
      animation: pl-pop .18s ease-out
    }

    @keyframes pl-pop {
      from {
        transform: translateY(8px);
        opacity: 0
      }

      to {
        transform: none;
        opacity: 1
      }
    }

    .pl-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      border-bottom: 1px solid #eef2f7
    }

    .pl-modal__header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #0f172a
    }

    .pl-icon-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      color: #64748b
    }

    .pl-icon-btn:hover {
      color: #111827
    }

    .pl-modal__body {
      padding: 16px 18px;
      display: grid;
      gap: 12px
    }

    .pl-field label {
      display: block;
      font-size: 12px;
      color: #334155;
      margin-bottom: 6px
    }

    .pl-input {
      width: 100%;
      font-size: 14px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      outline: none;
      background: #fff
    }

    .pl-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .15)
    }

    .pl-help {
      font-size: 12px;
      color: #ef4444;
      margin-top: -4px
    }

    .pl-modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 12px 18px 16px;
      border-top: 1px solid #eef2f7
    }

    .pl-btn {
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer
    }

    .pl-btn:hover {
      background: #f8fafc
    }

    .pl-btn--primary {
      border-color: #4f46e5;
      background: #4f46e5;
      color: #fff
    }

    .pl-btn--primary:hover {
      filter: brightness(0.95)
    }

    .topbar .topbar-actions {
      display: flex;
      align-items: center;
      gap: 0
    }

    .pl-modal-overlay[hidden] {
      display: none !important;
    }
  </style>

  <script>
    window.addEventListener('pageshow', function (e) {
      if (e.persisted) location.reload();
    });

    (function () {
      const modal = document.getElementById('pwChangeModal');
      const form = document.getElementById('pwChangeForm');
      const help = document.getElementById('pwHelp');
      const openBtn = document.getElementById('openPwChange');

      function openModal() { modal.removeAttribute('hidden'); setTimeout(() => document.getElementById('curPw')?.focus(), 0); }
      function closeModal() { modal.setAttribute('hidden', ''); form.reset(); help.style.display = 'none'; help.textContent = ''; }

      openBtn?.addEventListener('click', openModal);
      modal?.addEventListener('click', (e) => { if (e.target === modal || e.target.closest('[data-close-modal]')) closeModal(); });
      window.addEventListener('keydown', (e) => { if (!modal.hasAttribute('hidden') && e.key === 'Escape') closeModal(); });

      function getCsrf() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        const headerMeta = document.querySelector('meta[name="_csrf_header"]');
        if (tokenMeta && headerMeta) return { header: headerMeta.content || 'X-CSRF-TOKEN', token: tokenMeta.content };

        const logoutForm = document.querySelector('form[method="post"][action$="/admin/logout"]');
        if (logoutForm) {
          const input = logoutForm.querySelector('input[type="hidden"]');
          if (input && input.name && input.value) {
            return { header: 'X-CSRF-TOKEN', token: input.value };
          }
        }
        return { header: 'X-CSRF-TOKEN', token: '' };
      }

      form?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const curPw = (document.getElementById('curPw').value || '').trim();
        const newPw = (document.getElementById('newPw').value || '').trim();
        const newPw2 = (document.getElementById('newPw2').value || '').trim();

        if (!curPw || !newPw || !newPw2) {
          help.textContent = '모든 항목을 입력하세요.';
          help.style.display = 'block';
          return;
        }
        if (newPw !== newPw2) {
          help.textContent = '새 비밀번호가 일치하지 않습니다.';
          help.style.display = 'block';
          return;
        }

        const { header, token } = getCsrf();

        try {
          const res = await fetch('/account/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              [header]: token
            },
            body: JSON.stringify({ curPw, newPw, newPw2 })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.ok === false) {
            throw new Error(data.message || '오류가 발생했습니다.');
          }

          alert(data.message || '비밀번호가 변경되었습니다.');
          closeModal();
        } catch (err) {
          help.textContent = err.message || '오류가 발생했습니다.';
          help.style.display = 'block';
        }
      });
    })();
  </script>
</header>