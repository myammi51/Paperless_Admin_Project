<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${'문서 상세 · #' + dto.plId}">문서 상세</title>

  <!-- 프로젝트 공통 CSS가 있다면 경로만 유지 -->
  <link rel="stylesheet" th:href="@{/admin/css/admin.css}" />
  <link rel="stylesheet" th:href="@{/paperless/css/paperless.css}" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    /* 최소 UI 스타일(공통 CSS가 충분하면 이 블록은 제거 가능) */
    .container{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .main{padding:20px}
    .page-title{font-size:20px;margin:0 0 12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;background:#e5e7eb;color:#111827;font-size:12px}
    .badge--pending{background:#fef3c7;color:#92400e}
    .badge--success{background:#dcfce7;color:#166534}
    .badge--warn{background:#fee2e2;color:#991b1b}
    .card.section{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    .meta-card{display:grid;grid-template-columns:120px 1fr;row-gap:8px;column-gap:12px;margin:0}
    .one-line{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions-bar{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;text-decoration:none;color:#111827}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .attach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .attach-item{border:1px solid #e5e7eb;border-radius:10px;padding:8px;background:#fafafa}
    .thumb{position:relative;border-radius:8px;overflow:hidden;border:1px solid #e5e7eb;cursor:pointer}
    .thumb img{display:block;width:100%;height:160px;object-fit:cover}
    .thumb__dl{position:absolute;right:8px;bottom:8px;background:#fff;border:1px solid #e5e7eb;border-radius:9999px;padding:4px 8px}
    .lightbox{position:fixed;inset:0;display:none}
    .lightbox__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .lightbox__content{position:relative;z-index:1;max-width:min(92vw,1000px);margin:5vh auto;background:#000;border-radius:12px;padding:12px}
    .lightbox__content img{display:block;max-width:100%;max-height:72vh;margin:0 auto}
    .lightbox__caption{color:#fff;margin-top:8px;text-align:center}
    .lightbox__nav{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .lightbox__close{position:absolute;right:8px;top:4px;background:#fff;border:1px solid #e5e7eb;border-radius:9999px;width:32px;height:32px}
  </style>
</head>
<body>
  <div class="container">
    <!-- 상단/사이드 공통 프래그먼트 (프로젝트에 맞게 유지) -->
    <header th:replace="~{fragments/topbar :: topbar}"></header>
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <main class="main" role="main">
      <!-- 페이지 타이틀: title 사용 제거, docType만 사용 -->
      <h1 class="page-title">
        <span th:text="${'문서 #' + dto.plId}">문서 #0</span>
        <span> · </span>
        <span th:text="${#strings.defaultString(dto.docType, '문서')}">문서유형</span>
      </h1>

      <!-- 시스템 메시지 -->
      <div class="notice success" th:if="${msg != null}" th:text="${msg}" style="margin-bottom:12px;"></div>

      <!-- 메타 정보 카드: DTO 9개 필드만 사용 -->
      <div class="card section">
        <dl class="meta-card">
          <dt style="color:#64748b;">신청인</dt>
          <dd>
            <span th:text="${dto.userName != null ? dto.userName : (dto.userId != null ? 'ID ' + dto.userId : '-')}">-</span>
          </dd>

          <dt style="color:#64748b;">접수일</dt>
          <dd>
            <span th:if="${dto.submittedAt != null}"
                  th:text="${#temporals.format(dto.submittedAt, 'yyyy-MM-dd HH:mm')}">-</span>
            <span th:if="${dto.submittedAt == null}">-</span>
          </dd>

          <dt style="color:#64748b;">처리일</dt>
          <dd>
            <span th:if="${dto.processedAt != null}"
                  th:text="${#temporals.format(dto.processedAt, 'yyyy-MM-dd HH:mm')}">-</span>
            <span th:if="${dto.processedAt == null}">-</span>
          </dd>

          <dt style="color:#64748b;">상태</dt>
          <dd th:switch="${dto.status}">
            <span th:case="'WAITING'" class="badge badge--pending">접수</span>
            <span th:case="'IN_PROGRESS'" class="badge">진행</span>
            <span th:case="'ANSWERED'" class="badge badge--success">완료</span>
            <span th:case="'REJECTED'" class="badge badge--warn">반려</span>
            <span th:case="*" class="badge">-</span>
          </dd>

          <dt style="color:#64748b;">문서유형</dt>
          <dd th:text="${#strings.defaultString(dto.docType, '-')}">-</dd>

          <dt style="color:#64748b;">담당자</dt>
          <dd>
            <span th:text="${dto.adminName != null ? dto.adminName : (dto.adminId != null ? 'ID ' + dto.adminId : '-')}">-</span>
          </dd>
        </dl>
      </div>

      <!-- 첨부파일 -->
      <div class="card section" th:if="${files != null}">
        <h2 class="page-title" style="font-size:16px;">첨부파일</h2>
        <div th:if="${#lists.isEmpty(files)}" style="color:#64748b;">첨부된 파일이 없습니다.</div>

        <div class="attach-grid" th:if="${!#lists.isEmpty(files)}">
          <div class="attach-item" th:each="f, iterStat : ${files}">
            <!-- 이미지 미리보기 썸네일 -->
            <div class="thumb" th:if="${f.mimeType != null and #strings.startsWith(f.mimeType, 'image/')}"
                 role="button" tabindex="0"
                 th:attr="data-fileid=${f.fileId},data-filename=${f.fileName},data-index=${iterStat.index}"
                 aria-label="이미지 크게 보기">
              <img th:src="@{|/files/${f.fileId}/view|}" th:alt="${f.fileName}" loading="lazy" />
              <a class="thumb__dl" th:href="@{|/files/${f.fileId}/download|}"
                 th:attr="aria-label=${'다운로드: ' + f.fileName}" title="다운로드"
                 onclick="event.stopPropagation();">
                <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
                  <path d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4.001 4a1 1 0 0 1-1.414 0l-4.001-4a1 1 0 1 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1zM5 19a1 1 0 1 0 0 2h14a1 1 0 1 0 0-2H5z" fill="currentColor"/>
                </svg>
              </a>
            </div>

            <!-- 비이미지 파일: 링크만 -->
            <div th:if="${!(f.mimeType != null and #strings.startsWith(f.mimeType, 'image/'))}">
              <a th:href="@{|/files/${f.fileId}/download|}" th:text="${f.fileName}">첨부</a>
              <span style="color:#94a3b8;"
                    th:text="${' (' + (f.mimeType != null ? f.mimeType : 'application/octet-stream') + ', ' + f.fileSize + ' bytes)'}">
              </span>
            </div>

            <div class="filename one-line" th:title="${f.fileName}" th:text="${f.fileName}"></div>
          </div>
        </div>
      </div>

      <!-- 하단 액션 -->
      <div class="actions section actions-bar">
        <div class="left">
          <a class="btn" th:href="@{/mypage_paperlessDoc}">목록으로</a>
        </div>
      </div>
    </main>
  </div>

  <!-- 이미지 라이트박스 -->
  <div id="imageLightbox" class="lightbox" aria-hidden="true" style="display:none;">
    <div class="lightbox__backdrop" data-close="true"></div>
    <div class="lightbox__content" role="dialog" aria-modal="true" aria-label="이미지 미리보기">
      <button type="button" class="lightbox__close" aria-label="닫기" data-close="true">×</button>
      <img id="lightboxImg" alt="첨부 이미지" />
      <div id="lightboxCaption" class="lightbox__caption"></div>
      <div class="lightbox__nav">
        <button type="button" id="lightboxPrev" class="btn sm" aria-label="이전">‹</button>
        <button type="button" id="lightboxNext" class="btn sm" aria-label="다음">›</button>
        <a id="lightboxDownload" class="btn sm" href="#" download>다운로드</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const curr = document.querySelector('.nav a[href="/admin/document_list"]');
      if (curr) curr.classList.add('active');
    })();
    
    (function () {
      const grid = document.querySelector('.attach-grid');
      const lb = document.getElementById('imageLightbox');
      const lbImg = document.getElementById('lightboxImg');
      const lbCaption = document.getElementById('lightboxCaption');
      const lbDownload = document.getElementById('lightboxDownload');
      const btnPrev = document.getElementById('lightboxPrev');
      const btnNext = document.getElementById('lightboxNext');

      let items = [];
      let lbIndex = 0;

      if (grid) {
        const thumbs = grid.querySelectorAll('.thumb[data-fileid]');
        items = Array.from(thumbs).map((el) => ({
          id: el.getAttribute('data-fileid'),
          filename: el.getAttribute('data-filename')
        }));

        thumbs.forEach((el, idx) => {
          el.addEventListener('click', () => openAt(idx));
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openAt(idx); }
          });
        });

        btnPrev.addEventListener('click', () => move(-1));
        btnNext.addEventListener('click', () => move(1));
        lb.addEventListener('click', (e) => { if (e.target.dataset.close === 'true') closeLb(); });
        document.addEventListener('keydown', (e) => {
          if (lb.style.display !== 'none') {
            if (e.key === 'Escape') closeLb();
            if (e.key === 'ArrowLeft') move(-1);
            if (e.key === 'ArrowRight') move(1);
          }
        });
      }

      function openAt(index) { if (!items.length) return; lbIndex = index; render(); lb.style.display='block'; lb.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
      function closeLb(){ lb.style.display='none'; lb.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
      function move(delta){ lbIndex = (lbIndex + delta + items.length) % items.length; render(); }
      function render(){
        const item = items[lbIndex];
        const viewUrl = `/files/${item.id}/view`;
        const dlUrl = `/files/${item.id}/download`;
        lbImg.src = viewUrl; lbImg.alt = item.filename || '첨부 이미지';
        lbCaption.textContent = item.filename || '';
        lbDownload.href = dlUrl;
        lbDownload.setAttribute('download', item.filename || '');
      }
    })();
  </script>
</body>
</html>
